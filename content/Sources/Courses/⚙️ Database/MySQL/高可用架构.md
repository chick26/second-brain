---
title: 高可用架构
creation date: 2022-07-13 09:22 
status: done
tags:
- Sources/Courses/MySQL
- Development/Backend/Database/MySQL
---
up:: [[Sources/Courses/⚙️ Database/MySQL/• TOC for MySQL Course|• TOC for MySQL Course]]

MySQL 的主从复制是一种主从式的架构。由于整个架构中只存在一个主节点 `master`，当它发了宕机或者出现问题的时候势 必影响整个集群的正常工作。因此需要基于高可用的架构来解决 MySQL 主从复制的单点故障问题。

高可用架构的核心就是对主节点 `master` 进行监控，当其出现故障的时候通过提升某一从节点为新的主节点，从而实现故障的自动转移。

## MHA

`MHA` (Master HA) 能够在 30 秒内实 现故障切换，并能在故障切换中，最大可能的保证数据一致性。`MHA` 主备切换的过程如下：

- 从宕机崩溃的 `master` 主节点上保存二进制日志事件 `binlog events` 
- 识别含有最新更新的 `slave` 从节点 
- 应用中继日志 `relay log` 到其他 `slave` 从节点
- 应用从 `master` 主节点保存的二进制日志事件 `binlog events`
- 提升一个 `slave` 从节点为新的 `master` 主节点
- 使用其他的 `slave` 从节点连接到新的 `master` 主节点。

## KeepAlived

`KeepAlived` 可以实现 MySQL 主主复制的高可用。使用 `KeepAlived` + `MySQL` 主主复制的方式除了具备高可用的特性以外，它的部署和维护都非常简单。因此对于小型项目来说，一般推荐使用这样的方式。

`Keepailived` 有一台主服务器 `master` 和多台备份服务器 `backup`，在主服务器和备份服务器上面部署相同的服务配置，使用一个虚拟的 VIP 地址对外提供服务，当主服务器出现故障时，虚拟的 VIP 地址会自动漂移到备份服务器。

## PXC

基于 `MHA` 的 MySQL 高可用架构和基于 `KeepAlived` 的 MySQL 高可用架构存在的最大问题是存在数据复制的延迟。在有一些数据同步要求较高的场景中，这两种 HA 的架构就无法满足要求。而基于 `PXC` 的 MySQL 高可用架构却能很好地解决这一问题，达到数据的实时同步。

`PXC` 具有以下的优点：
- 实现了 MySQL 数据库的高可用和数据的强一致性
- 完成了真正的多节点读写的集群方案
- 基本达到了实时同步，改善了传统意义上的主从延迟问题
- 新加入的节点可以自动部署，无需提供手动备份
- 数据库的故障切换容易。

`PXC` 也存在一定的缺点，主要体现在以下几个方面:
- 新加入的节点开销大，需要复制完整的数据
- 任何更新事务都需要全局验证通过，才会在每个节点库上执行
- 集群性能受限于性能最差的节点
- 因为需要保证数据的一致性，所以在多个节点并发写时，冲突比较严重
- 存在写扩大问题，所有节点都会发生写操作
- 只支持 [[InnoDB存储引擎.md| InnoDB]] 存储引擎 没有表级别的锁定，执行 DDL 语句操作会把整个集群锁住 
- 所有表必须有主键，不然操作数据时会报错

## MGR

在 `MGR` 出现之前，MySQL 集群的主从复制都是采用的是异步复制的方式或者半同步复 制的方式。无论是哪种方式，数据的一致性问题都无法保证。为了解决这个问题，MySQL 官方在 5.7.17 版本正式推出 `MySQL Group Replication`，简称 `MGR`，即：MySQL 的组复制。

`MGR` 是 MySQL 一个全新的高可用与高扩展的解决方案并以插件形式提供，实现了分布式下数据的最终一致性。一个 `MGR` 复制组由若干个数据库实例的节点组成，组内各个节点维护各自的数据副本。`MGR` 通过一致性协议实现原子消息和全局有序消息从而保证组内实例数据的一致。

>[!TIPS]
>异步复制的方式是指主节点 `master` 执行事务，写入 `binlog` 日志然后提交。从节点 `slave` 接收 `binlog` 日志事务并将事务先写入中继日志，然后重做事务。当主节点 `master` 宕机时有可能会造成数据不一致情况。
>半同步复制的方式是指主节点 `master` 执行事务写入 `binlog` 日志，将 `binlog` 事务日志传送到从节点`slave`。从节点 `slave` 接收到 `binlog` 事务日志后，将其写到中继日志中，然后向主节点 `master` 返回传送成功 `ACK`。当主节点 `master` 收到 `ACK` 后，再提交事务。

`MGR` 复制组在使用过程中存在以下的限制和不足：
- 仅支持 `InnoDB` 表，并且每张表一定要有一个主键
- 必须打开 `GTID` 特性，二进制日志格式必须设置为 `ROW`
- 事务提交可能会失败
- 目前一个 `MGR` 集群最多支持 9 个数据库实例的节点
- 不支持外键于事务的存储点特性 
- 无法做全局间的约束检测与部分部分回滚
- 二进制日志不支持 `binlog event checksum`